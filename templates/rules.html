{% extends "base.html" %}

{% block content %}
<div class="layui-card">
  <div class="layui-card-header">采集规则库</div>
  <div class="layui-card-body">
    <form class="layui-form" action="javascript:void(0);" style="margin-bottom: 12px;">
      <div class="layui-form-item">
        <div class="layui-inline">
          <label class="layui-form-label">站点</label>
          <div class="layui-input-inline">
            <input type="text" placeholder="例如: xinhuanet.com" autocomplete="off" class="layui-input" id="site">
          </div>
        </div>
        <div class="layui-inline">
          <button class="layui-btn" id="create-btn">新增规则</button>
          <button class="layui-btn layui-btn-danger" id="batch-del-btn">批量删除</button>
          <button class="layui-btn layui-btn-primary" id="search-btn">查询</button>
        </div>
      </div>
    </form>

    <table class="layui-table" id="rules-table" lay-size="sm">
      <colgroup>
        <col width="40">
        <col width="60">
        <col width="150">
        <col width="100">
        <col width="200">
        <col width="150">
        <col width="150">
        <col>
        <col width="160">
        <col width="120">
      </colgroup>
      <thead>
        <tr>
          <th style="text-align:center;"><input type="checkbox" id="check-all"></th>
          <th>ID</th>
          <th>名称</th>
          <th>匹配类型</th>
          <th>站点/来源</th>
          <th>标题XPath</th>
          <th>详细XPath</th>
          <th>Headers(JSON)</th>
          <th>创建时间</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- Rule Form Template -->
<script type="text/html" id="rule-form-tpl">
  <div style="padding:20px;">
    <div class="layui-form" lay-filter="rule-form">
      <div class="layui-form-item">
        <label class="layui-form-label">规则名称</label>
        <div class="layui-input-block">
          <input type="text" name="name" required lay-verify="required" placeholder="例如：新华网规则" autocomplete="off" class="layui-input">
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">匹配类型</label>
        <div class="layui-input-block">
          <select name="match_type">
            <option value="domain">域名匹配</option>
            <option value="source">来源匹配</option>
          </select>
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">站点/来源</label>
        <div class="layui-input-block">
          <input type="text" name="site" required lay-verify="required" placeholder="域名(xinhuanet.com) 或 来源(新华网)" autocomplete="off" class="layui-input">
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">标题XPath</label>
        <div class="layui-input-block">
          <input type="text" name="title_xpath" placeholder="//h1" autocomplete="off" class="layui-input">
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">详细XPath</label>
        <div class="layui-input-block">
          <input type="text" name="content_xpath" placeholder="//article" autocomplete="off" class="layui-input">
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">Headers</label>
        <div class="layui-input-block">
          <textarea name="headers_json" placeholder='{"User-Agent": "..."}' class="layui-textarea" rows="4"></textarea>
        </div>
      </div>
      <div class="layui-form-item" style="text-align:right; margin-top:20px;">
        <button class="layui-btn" lay-submit lay-filter="saveRule">保存</button>
        <button type="button" class="layui-btn layui-btn-primary" id="cancel-btn">取消</button>
      </div>
    </div>
  </div>
</script>

<script>
layui.use(['layer','element','form'], function(){
  var layer = layui.layer;
  var element = layui.element;
  var form = layui.form;
  var $ = layui.$;

  var state = { keyword: '' };
  var rulesMap = {};
  var currentLayerIndex = null;
  var currentEditId = null;

  function loadRules(){
    var url = '/rules/list?keyword=' + encodeURIComponent(state.keyword);
    $.getJSON(url, function(res){
      var rows = '';
      rulesMap = {};
      res.items.forEach(function(r){
        rulesMap[r.id] = r;
        var matchTypeStr = r.match_type === 'source' ? '<span class="layui-badge layui-bg-blue">来源匹配</span>' : '<span class="layui-badge layui-bg-green">域名匹配</span>';
        rows += '<tr>' +
          '<td style="text-align:center;"><input type="checkbox" class="rule-check" value="'+ r.id +'"></td>' +
          '<td>'+ r.id +'</td>' +
          '<td>'+ (r.name||'未命名') +'</td>' +
          '<td>'+ matchTypeStr +'</td>' +
          '<td><div style="max-width: 180px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="'+ (r.site||'') +'">'+ (r.site||'') +'</div></td>' +
          '<td><div style="max-width: 140px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="'+ (r.title_xpath||'') +'">'+ (r.title_xpath||'') +'</div></td>' +
          '<td><div style="max-width: 140px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="'+ (r.content_xpath||'') +'">'+ (r.content_xpath||'') +'</div></td>' +
          '<td><div style="max-width: 150px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="'+ (r.headers_json||'') +'">'+ (r.headers_json||'') +'</div></td>' +
          '<td>'+ (r.created_at||'') +'</td>' +
          '<td>' +
            '<button class="layui-btn layui-btn-normal layui-btn-xs" data-action="edit" data-id="'+ r.id +'">编辑</button>' +
            '<button class="layui-btn layui-btn-danger layui-btn-xs" data-action="del" data-id="'+ r.id +'" style="margin-left:6px;">删除</button>' +
          '</td>' +
        '</tr>';
      });
      $('#rules-table tbody').html(rows);
      $('#check-all').prop('checked', false);
    });
  }

  $('#check-all').on('change', function(){
    var checked = $(this).prop('checked');
    $('.rule-check').prop('checked', checked);
  });

  $('#batch-del-btn').on('click', function(){
    var ids = [];
    $('.rule-check:checked').each(function(){
      ids.push(Number($(this).val()));
    });
    if(ids.length === 0){
      layer.msg('请先选择要删除的规则');
      return false;
    }
    layer.confirm('确认删除选中的 ' + ids.length + ' 条规则？', function(index){
      layer.load(1);
      $.ajax({
        url: '/rules/batch_delete',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ ids: ids })
      })
      .done(function(res){
        layer.closeAll('loading');
        layer.msg('已删除 ' + res.deleted + ' 条规则');
        loadRules();
      })
      .fail(function(){
        layer.closeAll('loading');
        layer.msg('删除失败', {icon: 2});
      });
      layer.close(index);
    });
    return false;
  });

  $('#search-btn').on('click', function(){
    state.keyword = $('#site').val();
    loadRules();
    return false;
  });

  // Open Form Modal (Create or Edit)
  function openRuleForm(data) {
    currentEditId = data ? data.id : null;
    var title = data ? '编辑规则' : '新增规则';
    
    currentLayerIndex = layer.open({
      type: 1,
      area: ['720px', '600px'],
      title: title,
      content: $('#rule-form-tpl').html(),
      success: function(layero, index){
        // Initialize form values
        form.render();
        if(data) {
          form.val('rule-form', {
            "name": data.name,
            "match_type": data.match_type,
            "site": data.site,
            "title_xpath": data.title_xpath,
            "content_xpath": data.content_xpath,
            "headers_json": data.headers_json
          });
        }
        
        // Bind Cancel
        $('#cancel-btn').on('click', function(){
          layer.close(index);
        });
      }
    });
  }

  // Handle Save
  form.on('submit(saveRule)', function(data){
    var field = data.field;
    var url = currentEditId ? '/rules/update' : '/rules/create';
    
    if(currentEditId) {
      field.id = currentEditId;
    }

    layer.load(1);
    $.ajax({
      url: url,
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(field)
    })
    .done(function(res){
      layer.closeAll('loading');
      layer.close(currentLayerIndex);
      layer.msg('保存成功', {icon: 1});
      loadRules();
    })
    .fail(function(err){
      layer.closeAll('loading');
      var msg = '保存失败';
      if(err.responseJSON && err.responseJSON.error) {
        msg += ': ' + err.responseJSON.error;
      }
      layer.msg(msg, {icon: 2});
    });
    return false;
  });

  $('#create-btn').on('click', function(){
    openRuleForm(null);
    return false;
  });

  $(document).on('click', 'button[data-action="edit"]', function(){
    var id = $(this).attr('data-id');
    var r = rulesMap[id];
    if(r) {
      openRuleForm(r);
    }
  });

  $(document).on('click', 'button[data-action="del"]', function(){
    var id = $(this).attr('data-id');
    layer.confirm('确认删除该规则？', function(index){
      layer.load(1);
      $.ajax({ url:'/rules/delete', method:'POST', contentType:'application/json', data: JSON.stringify({ id: Number(id) }) })
        .done(function(){ layer.closeAll('loading'); layer.msg('已删除'); loadRules(); })
        .fail(function(){ layer.closeAll('loading'); layer.msg('删除失败', {icon:2}); });
      layer.close(index);
    });
  });

  // Initial Load
  loadRules();
});
</script>
{% endblock %}
