{% extends "base.html" %}

{% block content %}
<div class="layui-card">
  <div class="layui-card-header">数据仓库管理</div>
  <div class="layui-card-body">
    <form class="layui-form" action="javascript:void(0);" style="margin-bottom: 12px;">
      <div class="layui-form-item">
        <div class="layui-inline">
          <label class="layui-form-label">关键字</label>
          <div class="layui-input-inline">
            <input type="text" placeholder="按标题筛选" autocomplete="off" class="layui-input" id="kw">
          </div>
        </div>
        <div class="layui-inline">
          <button class="layui-btn" id="search-btn">查询</button>
          <button class="layui-btn layui-btn-warm" id="batch-deep-btn">批量深度采集</button>
          <button class="layui-btn layui-btn-normal" id="auto-assoc-btn">一键自动关联</button>
          <button class="layui-btn layui-btn-primary" id="select-assoc-btn" title="选中当前页已关联规则的数据" style="border-color: #1E9FFF; color: #1E9FFF;">选中已关联</button>
          <button class="layui-btn layui-btn-danger" id="batch-del-btn">批量删除</button>
          <button class="layui-btn layui-btn-primary" id="refresh-btn">刷新</button>
        </div>
      </div>
    </form>

    <table class="layui-table" id="warehouse-table">
      <thead>
        <tr>
          <th style="width: 40px;"><input type="checkbox" id="check-all"></th>
          <th>ID</th>
          <th>标题</th>
          <th>来源</th>
          <th>封面</th>
          <th>URL</th>
          <th>已深度</th>
          <th>创建时间</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="pagination" style="text-align: right; margin-top: 10px;"></div>
  </div>
  <div class="layui-card-footer" style="padding: 10px 15px; border-top: 1px solid #f6f6f6;">
    <button class="layui-btn layui-btn-normal" id="ai-analyze-btn">AI解析分析</button>
  </div>
</div>

<script>
layui.use(['layer','element','laypage'], function(){
  var layer = layui.layer;
  var element = layui.element;
  var laypage = layui.laypage;
  var $ = layui.$;

  var state = { page: 1, size: 20, keyword: '' };
  var defaultAvatar = "{{ url_for('static', filename='images/avatar.svg') }}";
  var warehouseItems = {}; // Store items by ID

  function loadData(){
    var url = '/warehouse/list?page=' + state.page + '&size=' + state.size + '&keyword=' + encodeURIComponent(state.keyword);
    $.getJSON(url, function(res){
      var rows = '';
      warehouseItems = {}; // Reset
      res.items.forEach(function(it){
        warehouseItems[it.id] = it;
        
        var sourceDisplay = it.source || '';
        if(it.domain){
            sourceDisplay += '<div style="color:#999;font-size:12px;">' + it.domain + '</div>';
        }
        var sourceClass = '';
        if(it.rule_id){
            var ruleName = it.rule_name || '关联';
            sourceDisplay = '<span class="layui-badge layui-bg-green" style="margin-right:5px;" title="已关联规则: '+ruleName+'">' + ruleName + '</span>' + sourceDisplay;
            sourceClass = 'style="background-color:#f0f9eb;"'; // Light green background for the cell
        }
        
        var rowStyle = '';
        if(it.deep_collected){
            rowStyle = 'style="background-color: #f0f9eb;"'; // Light green background for deep collected rows
        }
        
        rows += '<tr '+ rowStyle +'>' +
          '<td><input type="checkbox" class="wh-check" value="'+ it.id +'"></td>' +
          '<td>'+ it.id +'</td>' +
          '<td>'+ (it.title||'') +'</td>' +
          '<td '+ sourceClass +'>'+ sourceDisplay +'</td>' +
          '<td><img src="'+ (it.cover||defaultAvatar) +'" style="max-height:40px;" onerror="this.src=\''+ defaultAvatar +'\'" /></td>' +
          '<td><a href="'+ (it.url||'#') +'" target="_blank">链接</a></td>' +
          '<td>'+ (it.deep_collected ? '<span class="layui-badge layui-bg-green">是</span>' : '<span class="layui-badge layui-bg-gray">否</span>') +'</td>' +
          '<td>'+ (it.created_at||'') +'</td>' +
          '<td>' +
            '<button class="layui-btn layui-btn-xs" data-action="edit" data-id="'+ it.id +'">编辑</button>' +
            '<button class="layui-btn layui-btn-normal layui-btn-xs" data-action="preview" data-id="'+ it.id +'" style="margin-left:6px;">预览</button>' +
            '<button class="layui-btn layui-btn-danger layui-btn-xs" data-action="del" data-id="'+ it.id +'" style="margin-left:6px;">删除</button>' +
          '</td>' +
        '</tr>';
      });
      $('#warehouse-table tbody').html(rows);
      $('#check-all').prop('checked', false);

      // Render Pagination
      laypage.render({
        elem: 'pagination',
        count: res.total,
        limit: state.size,
        curr: state.page,
        layout: ['count', 'prev', 'page', 'next', 'limit', 'skip'],
        limits: [10, 20, 50, 100],
        jump: function(obj, first){
          if(!first){
            state.page = obj.curr;
            state.size = obj.limit;
            loadData();
          }
        }
      });
    });
  }

  $('#check-all').on('change', function(){
    var checked = $(this).prop('checked');
    $('.wh-check').prop('checked', checked);
  });

  $('#auto-assoc-btn').on('click', function(){
    layer.confirm('确认执行一键自动关联？<br>系统将根据[域名+来源名称]自动匹配规则库。', {icon: 3, title:'自动关联'}, function(index){
        layer.load(1);
        $.ajax({
            url: '/warehouse/auto_associate',
            method: 'POST',
            contentType: 'application/json'
        }).done(function(res){
            layer.closeAll('loading');
            layer.msg('已自动关联 ' + res.associated + ' 条数据');
            loadData();
        }).fail(function(xhr){
            layer.closeAll('loading');
            layer.msg('关联失败: ' + (xhr.responseJSON ? xhr.responseJSON.error : '未知错误'), {icon: 2});
        });
        layer.close(index);
    });
    return false;
  });

  $('#select-assoc-btn').on('click', function(){
    $('.wh-check').prop('checked', false);
    var count = 0;
    $.each(warehouseItems, function(id, it){
      if(it.rule_id){
        $('.wh-check[value="'+it.id+'"]').prop('checked', true);
        count++;
      }
    });
    layer.msg('已选中 ' + count + ' 条关联数据');
    return false;
  });

  $('#batch-deep-btn').on('click', function(){
    var ids = [];
    $('.wh-check:checked').each(function(){
      ids.push(Number($(this).val()));
    });
    if(ids.length === 0){
      layer.msg('请先选择要采集的数据');
      return false;
    }

    // Fetch rules first
    $.getJSON('/rules/list', function(res){
        var rules = res.items || [];
        var optionsHtml = '<option value="">-- 自动匹配 (默认) --</option>';
        rules.forEach(function(r){
            optionsHtml += '<option value="'+r.id+'">[' + (r.match_type=='source'?'来源':'域名') + '] ' + (r.name||'未命名') + ' - ' + r.site + '</option>';
        });

        var contentHtml = '<div style="padding: 20px;">' +
            '<div style="margin-bottom: 15px;">共选中 <span style="color:red;font-weight:bold;">' + ids.length + '</span> 条数据</div>' +
            '<div class="layui-form-item">' +
            '<label class="layui-form-label" style="width: 80px; padding-left:0;">采集策略</label>' +
            '<div class="layui-input-block" style="margin-left: 90px;">' +
            '<select id="deep-rule-select" class="layui-input" style="display:block;">' +
            optionsHtml +
            '</select>' +
            '<div style="color:#999;font-size:12px;margin-top:5px;">默认自动匹配：根据来源名称或域名自动查找规则。<br>手动指定：强制所有选中项使用指定规则。</div>' +
            '</div>' +
            '</div>' +
            '</div>';

        layer.open({
            type: 1,
            title: '批量深度采集',
            area: ['500px', '300px'],
            content: contentHtml,
            btn: ['开始采集', '取消'],
            yes: function(index, layero){
                var ruleId = $('#deep-rule-select').val();
                var payload = { ids: ids };
                if(ruleId) {
                    payload.rule_id = Number(ruleId);
                }

                layer.close(index);
                layer.load(1);
                
                $.ajax({
                    url: '/warehouse/batch_deep',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(payload)
                })
                .done(function(res){
                    layer.closeAll('loading');
                    if(res.processed > 0) {
                        layer.msg('深度采集完成！成功采集 ' + res.processed + ' 条数据的内容');
                    } else {
                        layer.msg('深度采集未获取到有效内容，请检查规则或源站状态', {icon: 2});
                    }
                    loadData();
                })
                .fail(function(){
                    layer.closeAll('loading');
                    layer.msg('采集失败', {icon: 2});
                });
            }
        });
    });
    
    return false;
  });

  $('#batch-del-btn').on('click', function(){
    var ids = [];
    $('.wh-check:checked').each(function(){
      ids.push(Number($(this).val()));
    });
    if(ids.length === 0){
      layer.msg('请先选择要删除的数据');
      return false;
    }
    layer.confirm('确认删除选中的 ' + ids.length + ' 条数据？<br><span style="color:red;">此操作不可恢复！</span>', {icon: 3, title:'危险操作'}, function(index){
      layer.load(1);
      $.ajax({
        url: '/warehouse/batch_delete',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ ids: ids })
      })
      .done(function(res){
        layer.closeAll('loading');
        layer.msg('已删除 ' + res.deleted + ' 条数据');
        loadData();
      })
      .fail(function(){
        layer.closeAll('loading');
        layer.msg('删除失败', {icon: 2});
      });
      layer.close(index);
    });
    return false;
  });

  $('#search-btn').on('click', function(){
    state.keyword = $('#kw').val();
    state.page = 1; // Reset to first page on new search
    loadData();
    return false;
  });
  $('#refresh-btn').on('click', function(){
    loadData();
    return false;
  });

  $(document).on('click', 'button[data-action="del"]', function(){
    var id = $(this).attr('data-id');
    layer.confirm('确认删除？', function(index){
      layer.load(1);
      $.ajax({
        url: '/warehouse/delete', method: 'POST', contentType: 'application/json',
        data: JSON.stringify({ id: Number(id) })
      }).done(function(){
        layer.closeAll('loading');
        layer.msg('已删除');
        loadData();
      }).fail(function(){
        layer.closeAll('loading');
        layer.msg('删除失败', {icon:2});
      });
      layer.close(index);
    });
  });

  $(document).on('click', 'button[data-action="preview"]', function(){
    var id = $(this).attr('data-id');
    var item = warehouseItems[id];
    if(!item){ layer.msg('数据未找到'); return; }
    
    var content = item.deep_content || '<div style="color:#ccc;text-align:center;padding:20px;">暂无内容</div>';
    
    var html = '<div style="height:100%;display:flex;flex-direction:column;">' +
      '<div style="flex:1;overflow-y:auto;padding:20px;background:#fff;" id="preview-container">' + content + '</div>' +
      '<div style="padding:10px;border-top:1px solid #eee;text-align:right;background:#f8f8f8;">' +
        '<button class="layui-btn" id="preview-save">保存内容</button>' +
      '</div>' +
    '</div>';
    
    var idx = layer.open({
      type: 1,
      title: '预览: ' + (item.title || '无标题'),
      area: ['800px', '600px'],
      content: html,
      success: function(layero, index){
        // Make content editable to allow saving changes?
        // The user said "save collected content".
        // If we just display HTML, editing is hard without a rich text editor.
        // But maybe they just want to verify?
        // "can view collected content, save collected content in database"
        // This implies if they like it, they keep it. But it is ALREADY in DB.
        // Maybe they want to EDIT it.
        // Let's make it `contentEditable` just in case, or provide a toggle?
        // Let's make it contentEditable for now.
        $('#preview-container').attr('contenteditable', 'true').css('outline', 'none');
        layer.tips('内容区域可直接编辑', '#preview-container', {tips: [1, '#3595CC'], time: 4000});
      }
    });
    
    $('#preview-save').on('click', function(){
       var newContent = $('#preview-container').html();
       layer.load(1);
       $.ajax({
         url: '/warehouse/update', method: 'POST', contentType: 'application/json',
         data: JSON.stringify({ id: Number(id), deep_content: newContent })
       }).done(function(){
         layer.closeAll('loading');
         layer.msg('内容已更新');
         // Update local cache
         if(warehouseItems[id]){ warehouseItems[id].deep_content = newContent; }
       }).fail(function(){
         layer.closeAll('loading');
         layer.msg('保存失败', {icon:2});
       });
    });
  });

  $(document).on('click', 'button[data-action="edit"]', function(){
    var id = $(this).attr('data-id');
    var item = warehouseItems[id];
    if(!item){ layer.msg('数据未找到'); return; }

    var html = ''+
      '<div style="padding:12px;">' +
      '<div class="layui-form-item"><label class="layui-form-label">标题</label><div class="layui-input-block"><input id="edit-title" class="layui-input" /></div></div>' +
      '<div class="layui-form-item"><label class="layui-form-label">来源</label><div class="layui-input-block"><input id="edit-source" class="layui-input" /></div></div>' +
      '<div class="layui-form-item"><label class="layui-form-label">URL</label><div class="layui-input-block"><input id="edit-url" class="layui-input" /></div></div>' +
      '<div class="layui-form-item"><label class="layui-form-label">封面</label><div class="layui-input-block"><input id="edit-cover" class="layui-input" /></div></div>' +
      '<div class="layui-form-item"><label class="layui-form-label">详细</label><div class="layui-input-block"><textarea id="edit-content" class="layui-textarea" rows="6"></textarea></div></div>' +
      '<div style="text-align:right;"><button class="layui-btn" id="edit-save">保存</button></div>' +
      '</div>';
    var idx = layer.open({ type:1, area:['640px','520px'], content: html, title: '编辑' });
    
    // Fill the content safely
    $('#edit-title').val(item.title || '');
    $('#edit-source').val(item.source || '');
    $('#edit-url').val(item.url || '');
    $('#edit-cover').val(item.cover || '');
    $('#edit-content').val(item.deep_content || '');

    $('#edit-save').on('click', function(){
      layer.load(1);
      $.ajax({
        url: '/warehouse/update', method: 'POST', contentType: 'application/json',
        data: JSON.stringify({ 
            id: Number(id), 
            title: $('#edit-title').val(), 
            source: $('#edit-source').val(), 
            url: $('#edit-url').val(), 
            cover: $('#edit-cover').val(), 
            deep_content: $('#edit-content').val() 
        })
      }).done(function(){
        layer.closeAll('loading');
        layer.close(idx);
        layer.msg('已保存');
        loadData();
      }).fail(function(){
        layer.closeAll('loading');
        layer.msg('保存失败', {icon:2});
      });
    });
  });

  $('#ai-analyze-btn').on('click', function(){
    var firstId = $('#warehouse-table tbody tr').first().find('button[data-action="edit"]').attr('data-id');
    layer.load(1);
    $.ajax({ url: '/warehouse/analyze', method: 'POST', contentType: 'application/json', data: JSON.stringify({ id: Number(firstId||0) }) })
      .done(function(res){ layer.closeAll('loading'); layer.msg('分析入口预留'); })
      .fail(function(){ layer.closeAll('loading'); layer.msg('分析调用失败', {icon:2}); });
  });

  loadData();
});
</script>
{% endblock %}
